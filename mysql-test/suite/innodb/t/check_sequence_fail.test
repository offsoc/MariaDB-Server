--source include/have_innodb.inc
--source include/have_debug.inc
--echo #
--echo # MDEV-36487 Fix ha_innobase::check() for sequences
--echo #

call mtr.add_suppression("InnoDB: Table test/s2 contains 1 indexes .*");
# Sequence table which has NO_ROLLBACK flag set
let $datadir=`select @@datadir`;
CREATE SEQUENCE s ENGINE=InnoDB;
copy_file $datadir/test/s.frm $datadir/test/s1.frm;
ALTER TABLE s SEQUENCE=0;
FLUSH TABLES;
remove_file $datadir/test/s.frm;
move_file $datadir/test/s1.frm $datadir/test/s.frm;
CHECK TABLE s;
DROP SEQUENCE s;

# Checks for more than one index
CREATE SEQUENCE s ENGINE=InnoDB;
copy_file $datadir/test/s.frm $datadir/test/orig.frm;
CREATE TABLE s2 LIKE s;
ALTER TABLE s2 sequence=0;
INSERT INTO s2 VALUES (3,1,9223372036854775806,1,1,1000,0,0);
ALTER TABLE s2 ADD INDEX idx(start_value);
FLUSH TABLES;
move_file $datadir/test/orig.frm $datadir/test/s2.frm;
SET STATEMENT DEBUG_DBUG="+d,skip_no_rollback_check" FOR
CHECK TABLE s2;
DROP SEQUENCE s;
DROP SEQUENCE s2;

# Should contain only one record
CREATE SEQUENCE s ENGINE=InnoDB;
copy_file $datadir/test/s.frm $datadir/test/orig.frm;
CREATE TABLE s2 LIKE s;
ALTER TABLE s2 sequence=0;
INSERT INTO s2 VALUES (3,1,9223372036854775806,1,1,1000,0,0);
DELETE FROM s2;
--source include/wait_all_purged.inc
FLUSH TABLES;
move_file $datadir/test/orig.frm $datadir/test/s2.frm;
SET STATEMENT DEBUG_DBUG="+d,skip_no_rollback_check" FOR
CHECK TABLE s2;
DROP SEQUENCE s;
DROP SEQUENCE s2;

# Checks for DB_TRX_ID & DB_ROLL_PTR in the record
CREATE SEQUENCE s ENGINE=InnoDB;
copy_file $datadir/test/s.frm $datadir/test/orig.frm;
CREATE TABLE s2 LIKE s;
ALTER TABLE s2 sequence=0;
DELETE FROM s2;
--source include/wait_all_purged.inc

--connect (prevent_purge,localhost,root)
START TRANSACTION WITH CONSISTENT SNAPSHOT;
--connection default
INSERT INTO s2 VALUES (3,1,9223372036854775806,1,1,1000,0,0);
FLUSH TABLES;
move_file $datadir/test/orig.frm $datadir/test/s2.frm;
SET STATEMENT DEBUG_DBUG="+d,skip_no_rollback_check" FOR
CHECK TABLE s2;
disconnect prevent_purge;
DROP SEQUENCE s;
DROP SEQUENCE s2;
