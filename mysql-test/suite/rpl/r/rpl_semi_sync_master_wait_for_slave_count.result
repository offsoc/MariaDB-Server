# MDEV-18983: `@@rpl_semi_sync_master_wait_for_slave_count` feature test
include/rpl_init.inc [topology=1->2, 1->3]
SET @dbug_reset= @@GLOBAL.debug_dbug;
# Case 0: Semi-Sync commits only when both slaves ACKs
connection server_3;
SET @dbug_reset= @@GLOBAL.debug_dbug;
SET @@GLOBAL.debug_dbug= '+d,simulate_delay_semisync_slave_reply';
connection server_1;
SET @@GLOBAL.debug_dbug= '+d,sync_semisync_report_reply';
CALL mtr.add_suppression('Timeout waiting for reply of binlog');
connection default;
SET @@SESSION.debug_sync= 'now WAIT_FOR report_reply_wait';
SET @@GLOBAL.debug_dbug= @dbug_reset;
SET @@SESSION.debug_sync= 'now SIGNAL report_reply_continue';
SHOW STATUS LIKE 'Rpl\_semi\_sync\_master\_%\_tx';
Variable_name	Value
Rpl_semi_sync_master_no_tx	0
Rpl_semi_sync_master_yes_tx	0
CREATE TABLE t (a INT);
connection server_3;
SET @@GLOBAL.debug_dbug= @dbug_reset;
SET @@SESSION.debug_sync= 'now SIGNAL io_thd_do_reply';
connection server_1;
connection default;
SHOW STATUS LIKE 'Rpl\_semi\_sync\_master\_%\_tx';
Variable_name	Value
Rpl_semi_sync_master_no_tx	0
Rpl_semi_sync_master_yes_tx	2
SHOW STATUS LIKE 'Rpl\_semi\_sync\_master\_get\_ack';
Variable_name	Value
Rpl_semi_sync_master_get_ack	4
connection server_2;
SHOW STATUS LIKE 'Rpl\_semi\_sync\_slave\_send\_ack';
Variable_name	Value
Rpl_semi_sync_slave_send_ack	2
connection server_3;
SHOW STATUS LIKE 'Rpl\_semi\_sync\_slave\_send\_ack';
Variable_name	Value
Rpl_semi_sync_slave_send_ack	2
connection server_1;
# Case 1: Lowering a high requirement unblocks the waiting Semi-Sync
SET @@GLOBAL.rpl_semi_sync_master_wait_for_slave_count= 3;
SET @@GLOBAL.debug_dbug= '+d,sync_semisync_report_reply';
FLUSH GLOBAL STATUS;
connection default;
SET @@SESSION.debug_sync= 'now WAIT_FOR report_reply_wait';
SET @@SESSION.debug_sync=
'now SIGNAL report_reply_continue WAIT_FOR report_reply_wait';
SET @@GLOBAL.debug_dbug= @dbug_reset;
SET @@SESSION.debug_sync= 'now SIGNAL report_reply_continue';
SHOW STATUS LIKE 'Rpl\_semi\_sync\_master\_%\_tx';
Variable_name	Value
Rpl_semi_sync_master_no_tx	0
Rpl_semi_sync_master_yes_tx	0
SET @@GLOBAL.rpl_semi_sync_master_wait_for_slave_count= 2;
connection server_1;
SHOW STATUS LIKE 'Rpl\_semi\_sync\_master\_%\_tx';
Variable_name	Value
Rpl_semi_sync_master_no_tx	0
Rpl_semi_sync_master_yes_tx	1
# Cases 2.x Matrix:
SET @@GLOBAL.rpl_semi_sync_master_wait_no_slave= 0;
# Case 2.1: falls back to Async when the requirement is set too high
SET @@GLOBAL.rpl_semi_sync_master_wait_for_slave_count= 3;
FLUSH GLOBAL STATUS;
SHOW STATUS LIKE 'Rpl\_semi\_sync\_master\_%\_tx';
Variable_name	Value
Rpl_semi_sync_master_no_tx	1
Rpl_semi_sync_master_yes_tx	0
# Case 2.3: stays Async as long as the requirement is not met
SET @@GLOBAL.debug_dbug= '+d,sync_semisync_report_reply';
INSERT INTO t VALUES (30) # ask for ACK(s);
SET @@SESSION.debug_sync= 'now WAIT_FOR report_reply_wait';
SET @@GLOBAL.debug_dbug= @dbug_reset;
SET @@SESSION.debug_sync= 'now SIGNAL report_reply_continue';
FLUSH GLOBAL STATUS;
SHOW STATUS LIKE 'Rpl\_semi\_sync\_master\_%\_tx';
Variable_name	Value
Rpl_semi_sync_master_no_tx	1
Rpl_semi_sync_master_yes_tx	0
# Case 2.4: returns to Semi-Sync when the requirement is set just right
SET @@GLOBAL.rpl_semi_sync_master_wait_for_slave_count= 2;
SET @@GLOBAL.debug_dbug= '+d,sync_semisync_report_reply';
INSERT INTO t VALUES (40) # ask for ACK(s);
SET @@SESSION.debug_sync= 'now WAIT_FOR report_reply_wait';
SET @@SESSION.debug_sync=
'now SIGNAL report_reply_continue WAIT_FOR report_reply_wait';
SET @@GLOBAL.debug_dbug= @dbug_reset;
SET @@SESSION.debug_sync= 'now SIGNAL report_reply_continue';
FLUSH GLOBAL STATUS;
SHOW STATUS LIKE 'Rpl\_semi\_sync\_master\_%\_tx';
Variable_name	Value
Rpl_semi_sync_master_no_tx	0
Rpl_semi_sync_master_yes_tx	1
# Cases 2.x Matrix:
SET @@GLOBAL.rpl_semi_sync_master_wait_no_slave= 1;
# Case 2.1: falls back to Async when the requirement is set too high
SET @@GLOBAL.rpl_semi_sync_master_wait_for_slave_count= 3;
FLUSH GLOBAL STATUS;
SHOW STATUS LIKE 'Rpl\_semi\_sync\_master\_%\_tx';
Variable_name	Value
Rpl_semi_sync_master_no_tx	1
Rpl_semi_sync_master_yes_tx	0
# Case 2.2: Semi-Sync stays timed-out on an up-to-date reconnect
SHOW STATUS LIKE 'Rpl\_semi\_sync\_master\_status';
Variable_name	Value
Rpl_semi_sync_master_status	OFF
connection server_3;
include/stop_slave.inc
include/start_slave.inc
connection server_1;
SHOW STATUS LIKE 'Rpl\_semi\_sync\_master\_status';
Variable_name	Value
Rpl_semi_sync_master_status	OFF
# Case 2.3: stays Async as long as the requirement is not met
SET @@GLOBAL.debug_dbug= '+d,sync_semisync_report_reply';
INSERT INTO t VALUES (31) # ask for ACK(s);
SET @@SESSION.debug_sync= 'now WAIT_FOR report_reply_wait';
SET @@GLOBAL.debug_dbug= @dbug_reset;
SET @@SESSION.debug_sync= 'now SIGNAL report_reply_continue';
FLUSH GLOBAL STATUS;
SHOW STATUS LIKE 'Rpl\_semi\_sync\_master\_%\_tx';
Variable_name	Value
Rpl_semi_sync_master_no_tx	1
Rpl_semi_sync_master_yes_tx	0
# Case 2.4: returns to Semi-Sync when the requirement is set just right
SET @@GLOBAL.rpl_semi_sync_master_wait_for_slave_count= 2;
SET @@GLOBAL.debug_dbug= '+d,sync_semisync_report_reply';
INSERT INTO t VALUES (41) # ask for ACK(s);
SET @@SESSION.debug_sync= 'now WAIT_FOR report_reply_wait';
SHOW WARNINGS;
Level	Code	Message
SHOW ERRORS;
Level	Code	Message
SET @@SESSION.debug_sync=
'now SIGNAL report_reply_continue WAIT_FOR report_reply_wait';
SET @@GLOBAL.debug_dbug= @dbug_reset;
SET @@SESSION.debug_sync= 'now SIGNAL report_reply_continue';
FLUSH GLOBAL STATUS;
SHOW STATUS LIKE 'Rpl\_semi\_sync\_master\_%\_tx';
Variable_name	Value
Rpl_semi_sync_master_no_tx	0
Rpl_semi_sync_master_yes_tx	1
# Cleanup
SET @@GLOBAL.debug_dbug= @dbug_reset;
SET @@SESSION.debug_sync= 'RESET';
DROP TABLE t;
include/rpl_end.inc
